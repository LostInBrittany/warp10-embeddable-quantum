<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="./quantumviz-tools.html"></head><body><dom-module id="quantumviz-annotation"><template><style>:host{display:block;}.annotation{position:relative;display:block;}.annotation svg{display:block;border:solid 1px black;height:20px;}.annotation-tooltip{position:absolute;min-width:200px;height:auto;padding:10px;background-color:rgba(255, 255, 255, 0.75);border-radius:10px;box-shadow:4px 4px 10px rgba(0, 0, 0, 0.4);pointer-events:none;z-index:1000;}.annotation-tooltip.hidden{display:none;}.annotation-tooltip p{margin:0;font-family:sans-serif;font-size:10pt;line-height:20px;}.gts-classname{color:#0074D9;}.gts-labelname{color:#3d9970;}.gts-separator{color:#bbbbbb;}.gts-labelvalue{color:#AAAAAA;font-style:italic;}</style><div class="annotation"><svg id="svg"></svg><div class="annotation-tooltip hidden"><p><strong class="timestamp"></strong></p><p><span class="name"></span> - <span class="value"></span></p></div></div></template></dom-module><script>class Warp10QuantumvizAnnotation extends Polymer.Element{static get is(){return'quantumviz-annotation'}static get properties(){return{width:{type:Number,value:-1},timeBounds:{type:Object,observer:'contentChanged'},chartArea:{type:Array,observer:'_changeDimensions'},annotation:{type:Array},vertGuide:{type:Number,notify:!0},selectedTimestamp:{type:Number,notify:!0,observer:'_selectedTimestampChanged',value:-1},debug:{type:Boolean,value:!1}}}connectedCallback(){super.connectedCallback(),this.SVG_MARGIN_LEFT=55,this.SVG_MARGIN_RIGHT=8,this.SVG_STROKE_WIDTH=0,this.NVD3_CHART_RIGHT_MARGIN=20,this.MAX_MARKER_WIDTH=10,this.setDimensions(),this.debug&&console.debug('[quantumviz-annotation] attached()'),this.isAttached=!0,this.contentChanged()}setDimensions(){this.dimensionAlreadyChanged||(this.debug&&console.debug('[quantumviz-annotation] setDimensions'),this.root.querySelector('.annotation').style.paddingLeft=this.SVG_MARGIN_LEFT+'px',this.root.querySelector('.annotation').style.paddingRight=this.SVG_MARGIN_RIGHT+'px',this.root.querySelector('.annotation').style.width='calc(100% -'+this.root.querySelector('.annotation').style.paddingLeft+' -'+this.root.querySelector('.annotation').style.paddingRight+');',this.root.querySelector('svg').style.width='100%')}_changeDimensions(){this.debug&&console.debug('[quantumviz-annotation] _changeDimensions',this.chartArea),this.root.querySelector('.annotation').style.paddingLeft=this.chartArea.x+'px',this.root.querySelector('svg').style.width=this.chartArea.w+'px',this.SVG_MARGIN_LEFT=this.chartArea.x,this.dimensionAlreadyChanged=!0}_selectedTimestampChanged(){this.debug&&console.debug('[quantumviz-annotation] _selectedTimestampChanged',this.selectedTimestamp)}contentChanged(){this.debug&&console.debug('[quantumviz-annotation] Content changed',this.annotation);let a=this;if(!this.isAttached||!this.timeBounds)return;this.debug&&console.debug('[quantumviz-annotation] Content changed - isAttached');let b,c=this.SVG_MARGIN_LEFT,e=this.SVG_STROKE_WIDTH,f=d3.select(a.root.querySelector('.annotation')),d=f.select('svg');b=0<this.root.querySelector('svg').getBoundingClientRect().width?this.root.querySelector('svg').getBoundingClientRect().width:this.root.querySelector('.annotation').getBoundingClientRect().width-this.SVG_MARGIN_LEFT-this.NVD3_CHART_RIGHT_MARGIN,this.debug&&(console.debug('[quantumviz-annotation] contentChanged - timeBounds',[this.timeBounds.min,this.timeBounds.max]),console.debug('[quantumviz-annotation] contentChanged - width',b,this.NVD3_CHART_RIGHT_MARGIN,this.root.querySelector('svg').definedWidth),console.debug('[quantumviz-annotation] annotation',this.annotation));let g=d3.scale.linear().domain([this.timeBounds.min,this.timeBounds.max]).range([0,b]),h=this.annotation,i=Math.max(b/h.values.length-2,1);this.debug&&console.debug('[quantumviz-annotation] markerWidth',i),i>this.MAX_MARKER_WIDTH&&(i=this.MAX_MARKER_WIDTH),this.debug&&(console.debug('[quantumviz-annotation] this.MAX_MARKER_WIDTH',this.MAX_MARKER_WIDTH),console.debug('[quantumviz-annotation] markerWidth',i));let j=(b)=>{a.selectedTimestamp=b.x,d3.select(this).attr('fill','orange'),d3.select(this).attr('stroke','orange'),f.select('.annotation-tooltip').select('.timestamp').text(d3.time.format.utc('%Y-%m-%dT%H:%M:%S.%LZ')(new Date(b.x))),f.select('.annotation-tooltip').select('.name').html(l(h.key)),f.select('.annotation-tooltip').select('.value').text(b.y),f.select('.annotation-tooltip').classed('hidden',!1);let d=f.select('.annotation-tooltip').node().getBoundingClientRect().width,j=g(b.x)+i/2+e/2+c-d/2;0>j&&(j=0);f.select('.annotation-tooltip').style('left',j+'px').style('bottom',30+'px'),this.debug&&console.debug('[quantumviz-annotation] annotationMouseover',{xPosition:j,x:b.x,scaledX:g(b.x),svgMarginLeft:c}),a.vertGuide=g(b.x)+c-e/2},k=()=>{a.selectedTimestamp=-1,d3.select(this).attr('fill',h.color),f.select('.annotation-tooltip').classed('hidden',!0),a.vertGuide=-1},l=(b)=>{let c=b.split(/\{[^}]*\}/);a.debug&&console.debug('[quantumviz-annotation] keyFormatter ',c);let d,e=[],f=/\{([^}]*)\}/g;for(;null!==(d=f.exec(b));)e.push(d[1]);a.debug&&console.debug('[quantumviz-annotation] keyFormatter ',e);let g='';return c.forEach((a,b)=>{if(g+='<span class="gts-classname">'+a+'</span>',e.length>b){g+='<span class="gts-separator">{</span>';let a=[];e[b].split(',').forEach(function(b){let c=b.split('='),d='<span class="gts-labelname">'+c[0]+'</span>';1<c.length&&(d+='<span class="gts-separator">=</span><span class="gts-labelvalue">'+c[1]+'</span>'),a.push(d)}),g+=a.join('<span class="gts-separator">,</span>')+'<span class="gts-separator">}</span>'}}),a.debug&&console.debug('[quantumviz-annotation] keyFormatter ',g),g};d.selectAll('rect').data(h.values).attr('x',function(a){return g(a.x)-i/2-e/2}).attr('y',0).attr('width',i).attr('height',20).attr('fill',h.color).attr('stroke',h.color).attr('stroke-width',e).on('mouseover',j).on('mouseout',k),d.selectAll('rect').data(h.values).enter().append('rect').attr('x',function(a){return g(a.x)-i/2-e/2}).attr('y',0).attr('width',i).attr('height',20).attr('fill',h.color).attr('stroke','white').attr('stroke-width',e).on('mouseover',j).on('mouseout',k)}}customElements.define(Warp10QuantumvizAnnotation.is,Warp10QuantumvizAnnotation);</script></body></html>