<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="./warp10-display-mixin.html"><link rel="import" href="../granite-js-dependencies-grabber/granite-js-dependencies-grabber.html"><script src="../dygraphs/dygraph-combined-dev.js"></script><script type="text/javascript" src="../dygraphs/extras/smooth-plotter.js"></script></head><body><dom-module id="warp10-display-chart"><template><style>:host{display:block;width:var(--default-width, 100%);height:var(--default-height, 100%);position:relative;}#chart{width:100%;height:100%;position:relative;}.chart-tooltip{position:absolute;width:var(--tooltip-width, 400px);height:auto;padding:10px;background-color:rgba(255, 255, 255, 0.85);border-radius:10px;box-shadow:4px 4px 10px rgba(0, 0, 0, 0.4);pointer-events:none;z-index:1000;font-family:sans-serif;line-height:20px;}.chart-tooltip.hidden{display:none;}.tr.highligh{background-color:#ffffa4;}.gts-classname,
      :host ::slotted(.gts-classname){color:#0074D9;}.gts-labelname,
      :host ::slotted(.gts-labelname){color:#3d9970;}.gts-separator{color:#bbbbbb;}.gts-labelvalue{color:#AAAAAA;font-style:italic;}.legend-color-guide .tr{display:flex;flex-direction:column;justify-content:center;}.legend-color-guide div{width:10px;height:10px;border-radius:5px;margin-right:5px;margin-top:5px;}.chart-tooltip .table{display:table;width:100%;white-space:normal;font-size:10pt !important;}.chart-tooltip .tr{display:flex;flex-direction:row;justify-content:center;}.chart-tooltip .key{text-align:left;padding-right:10px;word-wrap:break-word;word-break:break-word;width:calc(var(--tooltip-width, 400px) - 50px);}.chart-tooltip .value{text-align:right;}</style><div class$="chart-tooltip {{_isTooltipHidden(tooltip)}}"></div><div id="chart"></div><granite-js-dependencies-grabber id="granite-js-dependencies-grabber-demo" dependencies="[[_dependencies]]" on-dependency-is-ready="_onDependencyReady" debug="[[debug]]"></granite-js-dependencies-grabber></template><script>class Warp10DisplayDyChart extends Warp10DisplayMixin(Polymer.Element){static get is(){return'warp10-display-chart'}static get properties(){return{_dependencies:{type:Array,value:[{name:'d3',url:'../d3/d3.min.js'}]}}}static get observers(){return['dataChanged(data.*, timestamps, yLowerBound, yUpperBound)']}connectedCallback(){if(super.connectedCallback(),this._isAttached=!0,this.timezone&&''!==this.timezone){this.debug&&console.log('[warp10-display-chart] attached - Go grab the dependencies!',this.timezone);let a=Promise.resolve();a.then(this._getDependency(this._getDependencyPromiseResolve('moment',`${this.importPath}../moment/moment.js`))).then(this._getDependency(this._getDependencyPromiseResolve('moment.tz',`${this.importPath}../moment-timezone/builds/moment-timezone-with-data.min.js`))).then(this.domReady.bind(this))}else this.domReady.bind(this);this.debug&&console.log('[warp10-display-chart] attached',{width:this.width,height:this.height})}domReady(){this.chart&&this._resizeChart&&(this.debug&&console.log('[warp10-display-chart] attached - dimensionsChanged, resizing'),this.configure(),this.chart.resize()),this.chart&&this.chart.resize()}_getDependency(a){return this.debug&&console.log('[warp10-display-chart] _getDependency'),()=>new Promise(a)}_getDependencyPromiseResolve(a,b){return(c)=>{console.log('[leaflet-core] _getDependencyPromiseResolve',a,b),this._windowHasObject(a)?(this.dispatchEvent(new CustomEvent('dependency-is-ready',{detail:{name:a,url:b}})),c()):window[`_downloading_${a}`]?this._waitToLoadDependency(a,b,c):(window[`_downloading_${a}`]=!0,this._loadDependency(a,b,c))}}_loadDependency(a,b,c){let d=document.createElement('script');d.src=this.resolveUrl(b),d.onload=()=>{this._waitToLoadDependency(a,b,c)},document.head.appendChild(d)}_waitToLoadDependency(a,b,c){this._windowHasObject(a)?(this.dispatchEvent(new CustomEvent('dependency-is-ready',{detail:{name:a,url:b}})),c()):window.setTimeout(()=>{this._waitToLoadDependency(a,b,c)},5)}_windowHasObject(a){let b=a.split('.'),c='window';for(let d in b)if(b[d]&&(c+=`.${b[d]}`,void 0===eval(c)))return!1;return!0}dimensionsChanged(){this.isReady&&(this.debug&&console.log('[warp10-display-chart] dimensionsChanged'),this._resizeChart=!0)}currentValuesChanged(){null!==this.isReady&&(this.debug&&console.log('[warp10-display-chart] currentValuesChanged() - currentValues',this.currentValues),this._tooltipContent())}tooltipChanged(a,b){this.debug&&console.log('[warp10-display-chart] tooltipChanged - oldValue',a),this.debug&&console.log('[warp10-display-chart] tooltipChanged - newValue',b),null===this.tooltip||''===this.tooltip?this.root.querySelector('.chart-tooltip').innerHTML=this.tooltip:(this.debug&&console.log('[warp10-display-chart] tooltipChanged',this.tooltip),this.root.querySelector('.chart-tooltip').innerHTML=this.tooltip)}_isTooltipHidden(){return null===this.tooltip||''===this.tooltip?(this.debug&&console.log('[warp10-display-chart] _isTooltipHidden - true'),'hidden'):(this.debug&&console.log('[warp10-display-chart] _isTooltipHidden - false'),'')}_removeChartData(){this.debug&&console.log('[warp10-display-chart] _removeChartData'),this.chart&&(this.chart.destroy(),this.chart=null,this.tooltip=null)}_updateChartData(){this.debug&&console.log('[warp10-display-chart] _updateChartData - begin',this.data),this._data2dygraphs(this.data),this.debug&&console.log('[warp10-display-chart] _updateChartData -end',this.data)}_tooltipContent(){if(this.hideTooltip)return;let a=this,b=this.currentValues,c=this.timestamps;if(null===b)return void(this.tooltip=null);let d=function(a){return`<span class='gts-value'>${+a.toFixed(4)}</span>`},e=function(b){return c?b:a.timezone&&''!==a.timezone?moment.tz(b,a.timezone).format('MM/DD/YYYY, kk:mm:ss.SSS'):d3.time.format.utc('%Y-%m-%dT%H:%M:%S.%LZ')(new Date(b))},f=function(b){a.debug&&console.log('[warp10-display-chart] keyFormatter ',b);let c=b.split(/\{[^}]*\}/);a.debug&&console.log('[warp10-display-chart] keyFormatter ',c);let d,e=[],f=/\{([^}]*)\}/g;for(;null!==(d=f.exec(b));)e.push(d[1]);a.debug&&console.log('[warp10-display-chart] keyFormatter ',e,e.length);let g='';for(let a in c)if(c.hasOwnProperty(a)&&(g+=`<span class='gts-classname'>${c[a]}</span>`,e.length>a)){g+=`<span class='gts-separator'>{</span>`;let b=[];e[a].split(',').forEach(function(a){let c=a.split('='),d=`<span class='gts-labelname'>${c[0]}</span>`;1<c.length&&(d+=`<span class='gts-separator'>=</span><span class='gts-labelvalue'>${c[1]}</span>`),b.push(d)}),g+=`${b.join(`<span class='gts-separator'>,</span>`)}<span class='gts-separator'>}</span>`}return console.debug('[warp10-display-chart] keyFormatter ',g),g},g=d3.select(document.createElement('div'));g.classed('table');{let a=g.selectAll('div.thead').data([b]).enter().append('div').classed('thead',!0);a.append('div').classed('tr',!0).append('div').classed('td',!0).attr('colspan',3).append('strong').classed('x-value',!0).html(e(b.xValue))}let h=g.selectAll('div.tbody').data([b]).enter().append('div').classed('tbody',!0),i=h.selectAll('div.tr').data(b.yValues).enter().append('div').classed('tr',!0).classed('highlight',function(b){return a.debug&&console.log('[warp10-display-chart] hightlight',b),b.highlight});i.append('div').classed('td',!0).classed('legend-color-guide',!0).append('div').style('background-color',function(a){return a.color}),i.append('div').classed('td',!0).classed('key',!0).html(function(a,b){return f(a.name,b)}),i.append('div').classed('td',!0).classed('value',!0).html(function(a,b){return d(a.yval,b)}),i.selectAll('div.td').each(function(b){if(b.highlight){let c=d3.scale.linear().domain([0,1]).range(['#fff',b.color]),d=0.6;d3.select(a).style('border-bottom-color',c(d)).style('border-top-color',c(d))}});let j=g.node().outerHTML;void 0!==b.footer&&(j+=`<div class='footer'>${b.footer}</div>`),console.debug('[warp10-display-chart] _tooltipContent - html',j),this.debug&&(console.log('[warp10-display-chart] _tooltipContent - window.innerWidth',window.innerWidth),console.log('[warp10-display-chart] _tooltipContent - chart width',this.root.querySelector('#chart').style.width),console.log('[warp10-display-chart] _tooltipContent - chart getBoundingClientRect()',this.root.querySelector('#chart').getBoundingClientRect().width),console.log('[warp10-display-chart] _tooltipContent - chart getBoundingClientRect()',this.root.querySelector('#chart').getBoundingClientRect()),console.log('[warp10-display-chart] _tooltipContent - chart-tooltip getBoundingClientRect()',this.root.querySelector('.chart-tooltip').getBoundingClientRect().width));let k=window.innerWidth,l=this.$.chart.getBoundingClientRect().left,m=this.$.chart.getBoundingClientRect().width,n=this.currentValues.xCoord,o=this.currentValues.yCoord,p=this.root.querySelector('.chart-tooltip').getBoundingClientRect().width;if(this.debug&&console.log('[warp10-display-chart] tooltip',n,o),!(l+n+p+20>k)){this.root.querySelector('.chart-tooltip').style.left=n+20+'px',this.root.querySelector('.chart-tooltip').style.top=o-50+'px';let a={innerWidth:window.innerWidth,tooltip:this.root.querySelector('.chart-tooltip').getBoundingClientRect().width,xCoord:this.currentValues.xCoord,yCoord:this.currentValues.yCoord,sum:this.currentValues.xCoord+this.root.querySelector('.chart-tooltip').getBoundingClientRect().width+20,left:this.root.querySelector('.chart-tooltip').style.left,right:this.root.querySelector('.chart-tooltip').style.right,top:this.root.querySelector('.chart-tooltip').style.top,width:p};this.debug&&console.log('[warp10-display-chart] _tooltipContent - tooltip to the right',a)}else if(0>l+n-p-20){this.root.querySelector('.chart-tooltip').style.left=n-p/2+'px',this.root.querySelector('.chart-tooltip').style.right='auto',this.root.querySelector('.chart-tooltip').style.top=o+50+'px';let a={innerWidth:window.innerWidth,tooltip:this.root.querySelector('.chart-tooltip').getBoundingClientRect().width,xCoord:this.currentValues.xCoord,yCoord:this.currentValues.yCoord,sum:this.currentValues.xCoord+this.root.querySelector('.chart-tooltip').getBoundingClientRect().width+20,left:this.root.querySelector('.chart-tooltip').style.left,right:this.root.querySelector('.chart-tooltip').style.right,top:this.root.querySelector('.chart-tooltip').style.top};this.debug&&console.log('[warp10-display-chart] _tooltipContent - tooltip to center',a)}else{this.root.querySelector('.chart-tooltip').style.left='auto',this.root.querySelector('.chart-tooltip').style.right=m-n+20+'px',this.root.querySelector('.chart-tooltip').style.top=o-50+'px';let a={innerWidth:window.innerWidth,tooltip:this.root.querySelector('.chart-tooltip').getBoundingClientRect().width,xCoord:this.currentValues.xCoord,yCoord:this.currentValues.yCoord,sum:this.currentValues.xCoord+this.root.querySelector('.chart-tooltip').getBoundingClientRect().width+20,left:this.root.querySelector('.chart-tooltip').style.left,right:this.root.querySelector('.chart-tooltip').style.right,top:this.root.querySelector('.chart-tooltip').style.top};this.debug&&console.log('[warp10-display-chart] _tooltipContent - tooltip to the left',a)}this.tooltip=j,this.debug&&console.log('[warp10-display-chart] _tooltipContent',j)}_gts2dygraphs(a){let b=[];for(let c=0;c<a.length;c++)for(let d=0;d<a[c].v.length;d++)b.push(a[c].v[d][0]);b.sort(function(c,a){return c-a});let c=[b[0]];for(let d=1;d<b.length;d++)b[d]!==c[c.length-1]&&c.push(b[d]);let d=Array(c.length);for(let b=0;b<d.length;b++)d[b]=Array(a.length+1),d[b][0]=this.timestamps?c[b]:new Date(Math.floor(c[b]/1e3));for(let b=0;b<a.length;b++){let e=a[b].v.sort(function(c,a){return c[0]-a[0]}),f=0,g=0;for(;g<e.length&&f<c.length;){if(c[f]<e[g][0]){d[f][b+1]=null,f++;continue}if(c[f]===e[g][0]){d[f][b+1]=e[g][e[g].length-1],g++,f++;continue}g++}for(;f<c.length;)d[f][b+1]=null,f++}return d}_dataToChartLib(a){this.debug&&(console.log('[warp10-display-chart] _data2dygraphs - filteredResponse',a),console.log('[warp10-display-chart] _data2dygraphs - timezone',this.timezone));let b,c,d=this,e=this._gts2dygraphs(a.gts);for(let d=0;d<e.length;d++)for(let a=1;a<e[d].length;a++)!b&&e[d][a]&&(b=e[d][a]),!c&&e[d][a]&&(c=e[d][a]),e[d][a]>c&&e[d][a]&&(c=e[d][a]),e[d][a]<b&&e[d][a]&&(b=e[d][a]);this.debug&&(console.log('[warp10-display-chart] _data2dygraphs - sparklines',e),console.log('[warp10-display-chart] _data2dygraphs - timeBounds',this.timeBounds));let f=['X'].concat(this._params.labels),g={file:e,labels:f,labelsUTC:!0,connectSeparatedPoints:!0,maxNumberWidth:16,colors:this._params.colors,legend:'never',gridLineColor:'rgb(196, 196, 196)',xRangePad:5,yRangePad:5,dateWindow:[this.timeBounds.min,this.timeBounds.max],drawCallback:function(a){d.chartArea=a.getArea(),d.timeBounds={min:a.xAxisRange()[0],max:a.xAxisRange()[1]},d.valueBounds={min:a.yAxisRange()[0],max:a.yAxisRange()[1]}},valueRange:[Math.min(this.yLowerBound,b),Math.max(this.yUpperBound,c)]};if(this.hideAxis)g.drawAxis=!1,g.drawGrid=!1;else{if(this._params.xlabel&&(g.xlabel=this._params.xlabel),this._params.ylabel&&(g.ylabel=this._params.ylabel),g.axes={x:{drawAxis:!0,axisLabelFontSize:12,axisLineColor:'rgb(196, 196, 196)'},y:{drawAxis:!0,axisLabelFontSize:12,axisLabelFormatter:function(a){let b=a.toFixed(5),c=b.split('.'),d=c[0].replace(/(\d)(?=(\d{3})+(?!\d))/g,'$1,'),e=c[1].replace(/0+$/g,'');return 0===e.length?d:d+'.'+e}}},this.timezone){let a=this;g.axes.x.axisLabelFormatter=function(b){console.log('[warp10-display-chart] _data2dygraphs - timezone 2',a.timezone);let c=moment.tz(b,a.timezone),d=c.format('DD/MM')+'\n'+c.format('HH:mm');return d}}console.log('[warp10-display-chart] _data2dygraphs - timezone 3',g),'object'===typeof this._params.tickList&&(this.timestamps?g.axes.x.ticker=()=>Object.entries(this._params.tickList).map(([a,b])=>({v:parseInt(a),label:b})):(g.axes.x.axisLabelWidth=100,g.axes.x.ticker=()=>Object.entries(this._params.tickList).map(([a,b])=>({v:new Date(parseInt(a)/1e3),label:b})))),Array.isArray(this._params.tickList)&&(this.timestamps?g.axes.x.ticker=()=>this._params.tickList.map((a)=>({v:a,label:a})):(g.axes.x.axisLabelWidth=100,g.axes.x.ticker=()=>this._params.tickList.map((a)=>this.timezone?{v:new Date(a/1e3),label:moment.tz(a/1e3,this.timezone).format('YYYY-MM-DD, kk:mm:ss.SSS')}:{v:new Date(a/1e3),label:d3.time.format.utc('%Y-%m-%d %H:%M:%S')(new Date(a/1e3))})))}g.highlightCallback=function(a,b,c,e,f){this.debug&&console.log('[warp10-display-chart] highlightCallback',{event:a,name:f,x:b,points:c,row:e,xCoord:d.chart.toDomXCoord(b)});for(let g,h=0;h<c.length;h++)g=d._params.labels.indexOf(c[h].name),0<=g&&(c[h].color=d._params.colors[g]),this.debug&&console.log('[warp10-display-chart] color',c[h].color),c[h].color=d.chart.colors_[h],c[h].highlight=f===c[h].name;this.debug&&console.log('[warp10-display-chart] highlightCallback - points',c),d.currentValues={xValue:b,yValues:c,xCoord:d.chart.toDomXCoord(b),yCoord:a.layerY}},g.unhighlightCallback=function(){this.debug&&console.log('[warp10-display-chart] unhighlightCallback'),d.currentValues=null},g.interactionModel={mouseout:()=>{this.debug&&console.log('[warp10-display-chart] interactionModel mouseout'),d.currentValues=null}},this.hideTooltip||(g.highlightCircleSize=d.lineWidth+3,g.highlightSeriesOpts={strokeWidth:d.lineWidth+1,strokeBorderWidth:1,highlightCircleSize:d.lineWidth+3}),g.series={};for(let b=0;b<this._params.labels.length;b++)switch(g.series[this._params.labels[b]]={strokeWidth:this._params.strokeWidth[b]},this._params.interpolate[b]){case'cardinal':g.series[this._params.labels[b]].plotter=smoothPlotter,g.series[this._params.labels[b]].stepPlot=!1;break;case'step':case'step-after':case'step-before':g.series[this._params.labels[b]].plotter=Dygraph.Plotters.linePlotter,g.series[this._params.labels[b]].stepPlot=!0;break;case'line':case'linear':default:g.series[this._params.labels[b]].plotter=Dygraph.Plotters.linePlotter,g.series[this._params.labels[b]].stepPlot=!1;}this.debug&&console.log('[warp10-display-chart] _data2dygraphs - options',g),this.chart?this.chart.updateOptions(g):(this.debug&&console.log('[warp10-display-chart] _data2dygraphs - typeof this.$.chart',typeof this.$.chart),this.chart=new Dygraph(this.$.chart,e,g),this.debug&&console.log('[warp10-display-chart] _data2dygraphs - chart',this.chart),this.chart.maindiv_=this.$.chart,this.debug&&console.log('[warp10-display-chart] _data2dygraphs - chart',this.chart)),this.debug&&console.log('[warp10-display-chart] _data2dygraphs - chart',this.chart)}getChart(){return this.$.chart}}window.customElements.define(Warp10DisplayDyChart.is,Warp10DisplayDyChart);</script></dom-module></body></html>