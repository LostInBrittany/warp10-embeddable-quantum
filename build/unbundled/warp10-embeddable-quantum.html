<html><head><link rel="import" href="../polymer/polymer-element.html"><link rel="import" href="../iron-icon/iron-icon.html"><link rel="import" href="../paper-button/paper-button.html"><link rel="import" href="../warp10-iron/warp10-warpscript-caller.html"><link rel="import" href="../ace-widget/ace-widget.html"><link rel="import" href="../granite-alert/granite-alert.html"><link rel="import" href="../granite-spinner/granite-spinner.html"><link rel="import" href="../warp10-quantum-elements/quantum-response-container.html"><link rel="import" href="../warp10-quantum-elements/quantum-icons.html"></head><body>"<script src="../warp10-quantum-elements/ace/mode-warpscript.js"></script><script src="../ace-builds/src-min-noconflict/theme-eclipse.js"></script><script src="../ace-builds/src-min-noconflict/snippets/text.js"></script><link rel="import" href="./warp10-embeddable-quantum-conf.html"><link rel="import" href="./warp10-embeddable-quantum-plot.html"><dom-module id="warp10-embeddable-quantum"><template><style>:host{display:block;padding:30px;--app-primary-color:var(--google-blue-500);--app-secondary-color:black;--app-background-color:white;--app-on-background-color:white;}.title{text-transform:capitalize;}.button_bar{display:flex;justify-content:flex-end;align-items:center;}.clearfix:before,
      .clearfix:after{content:" ";display:table;}.clearfix:after{clear:both;}.top-10{margin-top:10px;}quantum-response-container[hidden]{display:none;}granite-alert[hidden]{display:none;}paper-button{background-color:var(--app-primary-color);color:var(--app-on-background-color);margin:5px;}paper-button iron-icon{padding-right:10px;}granite-spinner{z-index:100;}</style><warp10-warpscript-caller id="warpscriptcaller" url="[[_baseUrl]]" warpscript="[[warpscript]]" on-response="_handleResponse" on-error="_handleError" loading="{{loading}}" debug="[[debug]]"></warp10-warpscript-caller><h2 class="title">WarpScript</h2><ace-widget id="editor" theme="ace/theme/eclipse" mode="ace/mode/warpscript" softtabs="true" wrap="true" placeholder="Type your WarpScript here..." on-editor-content="editorChangeAction" initial-focus="" value="[[warpscript]]" debug="[[debug]]"><slot id="slot"></slot></ace-widget><div></div><granite-spinner active="[[loading]]" size="200" hover=""></granite-spinner><div class="top-10 button_bar"><paper-button id="btn_execute" class="btn btn-primary btn-lg" on-click="execute" disabled$="{{loading}}"><iron-icon icon="quantum-icons:check"></iron-icon>Execute</paper-button></div><template is="dom-if" if="{{_elapsedTimeShown}}"><div class="clearfix"></div><div class="top-10"><div class="right">Your last script execution took {{_formattedElapsedTime}} serverside, fetched {{_fetched}} datapoints and performed {{_operations}} WarpScript operations.</div></div></template><div class="clearfix"></div><div class="top-10"><quantum-response-container id="response_container" response="{{stack}}" received="{{received}}" hidden$="{{!_hasAResponse}}" debug="[[debug]]"></quantum-response-container><granite-alert level="danger" hidden$="{{!_hasAnError}}">{{errorMsg}}</granite-alert></div><div id="plot-container" class="top-10" hidden$="{{!_hasAResponse}}"><warp10-embeddable-quantum-plot stack="[[stack]]" debug="[[debug]]"></warp10-embeddable-quantum-plot></div></template><script>class Warp10EmbeddableQuantum extends Polymer.Element{static get is(){return'warp10-embeddable-quantum'}static get properties(){return{warpscript:{type:String,value:'',observer:'_onWarpscriptChange'},backend:{type:Object,observer:'_backendChanged',notify:!0},defaultBackend:{type:Object,value:{id:'default',label:'Default backend',url:'http://127.0.0.1:8080/api/v0',execEndpoint:'/exec',findEndpoint:'/find',updateEndpoint:'/update',deleteEndpoint:'/delete',headerName:'X-Warp10-Token'}},stack:{type:Array,notify:!0},elapsed:{type:Number,value:-1},_formattedElapsedTime:{type:String,computed:'_formatElapsedTime(elapsed)'},_elapsedTimeShown:{type:Boolean,computed:'_isElapsedTimeShown(elapsed)'},_hasAResponse:{type:Boolean,value:!1},_hasAnError:{type:Boolean,value:!1},_baseUrl:{type:String,computed:'_getBaseUrl(backend,backend.*)'},_dataToPlot:{type:Array,value:()=>[]},debug:{type:Boolean,value:!1}}}connectedCallback(){super.connectedCallback(),this.backend=JSON.parse(localStorage.getItem('warp10-backend-conf'))||this.defaultBackend,window.addEventListener('storage',(a)=>{this.debug&&console.log('[wapr10-embeddable-quantum] onStorage',a.key),'warp10-backend-conf'==a.key&&(this.backend=JSON.parse(localStorage.getItem('warp10-backend-conf')))}),this.debug&&console.log('[wapr10-embeddable-quantum] connectedCallback'),this._backendChanged(),!this.warpscript&&this.$.slot.assignedNodes()[0]&&(this.warpscript=this.$.slot.assignedNodes()[0].nodeValue)}_formatElapsedTime(){return 1e3>this.elapsed?''+this.elapsed+' ns':1e6>this.elapsed?''+(this.elapsed/1e3).toFixed(3)+' \u03BCs':1e9>this.elapsed?''+(this.elapsed/1e6).toFixed(3)+' ms':''+(this.elapsed/1e9).toFixed(3)+' s'}_isElapsedTimeShown(){return 0<this.elapsed}_getBaseUrl(){return this.debug&&console.log('[wapr10-embeddable-quantum] _getBaseUrl',this.backend),this.backend.url+this.backend.execEndpoint}_onWarpscriptChange(){this.debug&&console.log('[wapr10-embeddable-quantum] _onWarpscriptChange',this.warpscript)}_backendChanged(){this.backend||(this.backend=this.defaultBackend),this.backend.url||this.set('backend.url',this.defaultBackend.url),this.backend.execEndpoint||this.set('backend.execEndpoint',this.defaultBackend.execEndpoint),this.debug&&console.log('[wapr10-embeddable-quantum] _backendChanged',this.backend)}_handleResponse(a,b){this.debug&&console.debug('[wapr10-embeddable-quantum] _handleResponse',a,b);b.stack&&b.stack instanceof Array&&(this.elapsed=b.options.elapsed,this._fetched=b.options.fetched,this._operations=b.options.operations,this.stack=b.stack,this._hasAResponse=!0,this._hasAnError=!1,this.$.response_container.responseChanged(),this.debug&&console.debug('[wapr10-embeddable-quantum] _handleResponse',{stack:this.stack,elapsed:this.elapsed}))}_handleError(a,b){this.debug&&console.debug('[wapr10-embeddable-quantum] _handleError',b),this.errorMsg=b.errorLine&&b.errorMsg?'ERROR line #'+b.errorLine+': '+b.errorMsg:b.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)?b.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)[1]:b.request.xhr.statusText&&''!==b.request.xhr.statusText?b.request.statusText:'Unable to reach '+b.request.url,this.debug&&console.debug('[wapr10-embeddable-quantum] _handleError',{error:b,errorMsg:this.errorMsg}),this.elapsed=b.elapsed,this._fetched=b.fetched,this._operations=b.operations,this._hasAResponse=!1,this._hasAnError=!0}editorChangeAction(a){this.warpscript=a.detail.value,this.debug&&console.debug('[wapr10-embeddable-quantum] editorChangeAction',this.warpscript)}execute(){this.debug&&console.debug('[wapr10-embeddable-quantum] Execute',this.warpscript),this.$.warpscriptcaller.generateRequest()}}window.customElements.define(Warp10EmbeddableQuantum.is,Warp10EmbeddableQuantum);</script></dom-module></body></html>