<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../iron-ajax/iron-ajax.html"><link rel="import" href="./warp10-looseJSON.html"></head><body><dom-module id="warp10-warpscript-caller"><template><style>:host{display:none;}</style><iron-ajax id="xhr" url="{{url}}" content-type="application/x-www-form-urlencoded; charset=UTF-8" method="POST" body="{{warpscript}}" handle-as="text" on-response="_handleResponse" on-error="_handleError" loading="{{loading}}" debounce-duration="{{debounceDuration}}"></iron-ajax></template><script>Polymer({is:'warp10-warpscript-caller',properties:{url:{type:String,value:''},warpscript:{type:String,value:''},reload:{type:Number,value:-1},auto:{type:Boolean,value:!1},loading:{type:Boolean,value:!1,notify:!0},lastRequest:{type:Object,notify:!0,readOnly:!0},lastResponse:{type:Object,notify:!0,readOnly:!0},lastError:{type:Object,notify:!0,readOnly:!0},debounceDuration:{type:Number,value:0,notify:!0},debug:{type:Boolean,value:!1}},observers:['_optionsChanged(url, warpscript, reload, auto)'],attached:function(){this.debug&&console.log('[warp10-warpscript-caller] attached'),this.isAttached=!0,this.fire('attached')},detached:function(){this.debug&&console.log('[warp10-warpscript-caller] detached'),this._asyncTaskId&&this.cancelAsync(this._asyncTaskId)},generateRequest:function(){this.debug&&console.log('[warp10-warpscript-caller] generateRequest - WarpScript script',this.warpscript),this.cancelAsync(this._asyncTaskId),0<this.reload?(this._reloadInterval=1e3*parseFloat(this.reload),this.loading=!1,this._doCallWithReload()):this._doCall()},_optionsChanged:function(){let a=this;this.debounce('generate-request',function(){null===a.url||void 0===a.warpscript||0>=a.warpscript.length||a.auto&&a.generateRequest()},this.debounceDuration)},_doCall:function(){this.debug&&console.log('[warp10-warpscript-caller] doCall - Calling with WarpScript script',this.warpscript),this.fire('request',this.warpscript,{bubbles:!1}),this.lastRequest=this.$.xhr.generateRequest()},_doCallWithReload:function(){this.debug&&console.log(`[warp10-warpscript-caller] _doCallWithReload called with interval ${this._reloadInterval} ms`,this.loading),this.loading||this._doCall(),this._asyncTaskId=this.async(this._doCallWithReload,this._reloadInterval)},_getElapsed:function(a){var b=a.xhr.getAllResponseHeaders().split('\n').map(function(a){return a.split(':')[0].trim()});this.debug&&console.log('[warp10-warpscript-caller] _getElapsed - allowerHeaders',b);var c='X-Warp10-Elapsed';for(var d in b)b[d].match('-Elapsed')&&(c=b[d]);return a.xhr.getResponseHeader(c)},_getFetched:function(a){var b=a.xhr.getAllResponseHeaders().split('\n').map(function(a){return a.split(':')[0].trim()});this.debug&&console.log('[warp10-warpscript-caller] _getFetched - allowerHeaders',b);var c='X-Warp10-Fetched';for(var d in b)b[d].match('-Fetched')&&(c=b[d]);return a.xhr.getResponseHeader(c)},_getOperations:function(a){var b=a.xhr.getAllResponseHeaders().split('\n').map(function(a){return a.split(':')[0].trim()});this.debug&&console.log('[warp10-warpscript-caller] _getOperations - allowerHeaders',b);var c='X-Warp10-Ops';for(var d in b)b[d].match('-Ops')&&(c=b[d]);return a.xhr.getResponseHeader(c)},_getErrorLine:function(a){var b=a.xhr.getAllResponseHeaders().split('\n').map(function(a){return a.split(':')[0].trim()});this.debug&&console.log('[warp10-warpscript-caller] _getErrorLine - ironRequest.xhr.getAllResponseHeaders()',a.xhr.getAllResponseHeaders());var c='X-Warp10-Error-Line';for(var d in b)b[d].match('-Error-Line')&&(c=b[d]);return a.xhr.getResponseHeader(c)},_getErrorMsg:function(a){var b=a.xhr.getAllResponseHeaders().split('\n').map(function(a){return a.split(':')[0].trim()});this.debug&&console.log('[warp10-warpscript-caller] _getOperations - allowerHeaders',b);var c='X-Warp10-Error-Message';for(var d in b)b[d].match('-Error-Message')&&(c=b[d]);return a.xhr.getResponseHeader(c)},_handleResponse:function(a,b){a.stopPropagation();var c=this._getElapsed(b),d=this._getFetched(b),e=this._getOperations(b),f=looseJSON.parse(b.response),g={stack:f,options:{elapsed:c,fetched:d,operations:e}};this.lastResponse=g,this.debug&&console.log('[warp10-warpscript-caller] receivedResponse - Updated!',g),this.fire('response',g,{bubbles:!1}),this.loading=!1},_handleError:function(a,b){b.elapsed=this._getElapsed(b.request),b.fetched=this._getFetched(b.request),b.operations=this._getOperations(b.request),b.errorLine=this._getErrorLine(b.request),b.errorMsg=this._getErrorMsg(b.request),this.fire('error',b,{bubbles:!1}),this.loading=!1}});</script></dom-module></body></html>